<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CPAC Silo Monitoring Platform</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Thai:wght@300;400;500;600;700&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css">
<style>
  :root {
    --red: #CC0000;
    --red-dark: #A50000;
    --red-light: #FFE5E5;
    --gray-900: #1A1A1A;
    --gray-700: #3D3D3D;
    --gray-500: #6B6B6B;
    --gray-300: #CCCCCC;
    --gray-100: #F5F5F5;
    --gray-50: #FAFAFA;
    --white: #FFFFFF;
    --green: #2E7D32;
    --green-bg: #E8F5E9;
    --yellow: #F57F17;
    --yellow-bg: #FFF8E1;
    --status-green: #4CAF50;
    --status-yellow: #FFC107;
    --status-red: #F44336;
    --status-gray: #9E9E9E;
    --border: #E0E0E0;
    --shadow: 0 1px 4px rgba(0,0,0,0.08), 0 0 1px rgba(0,0,0,0.05);
    --shadow-md: 0 4px 16px rgba(0,0,0,0.10);
    --font: 'IBM Plex Sans Thai', sans-serif;
    --mono: 'IBM Plex Mono', monospace;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: var(--font);
    background: #EFEFEF;
    color: var(--gray-900);
    min-height: 100vh;
    font-size: 14px;
  }

  /* ‚îÄ‚îÄ TOP NAVIGATION ‚îÄ‚îÄ */
  .top-nav {
    background: var(--white);
    border-bottom: 3px solid var(--red);
    padding: 0 24px;
    height: 56px;
    display: flex;
    align-items: center;
    gap: 0;
    position: sticky;
    top: 0;
    z-index: 100;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  }
  .nav-logo {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-right: 32px;
  }
  .nav-logo-icon {
    width: 40px; height: 32px;
    border-radius: 4px;
    overflow: hidden;
    flex-shrink: 0;
  }
  .nav-logo-icon img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }
  .nav-logo-text { font-weight: 700; font-size: 16px; color: var(--gray-900); }
  .nav-logo-sub { font-size: 11px; color: var(--gray-500); font-weight: 400; }
  .nav-tabs { display: flex; height: 56px; }
  .nav-tab {
    height: 56px; padding: 0 20px;
    display: flex; align-items: center; gap: 6px;
    font-size: 13px; font-weight: 500;
    color: var(--gray-500);
    cursor: pointer;
    border-bottom: 3px solid transparent;
    margin-bottom: -3px;
    transition: all 0.15s;
    white-space: nowrap;
  }
  .nav-tab:hover { color: var(--gray-900); }
  .nav-tab.active { color: var(--red); border-bottom-color: var(--red); }
  .nav-tab .tab-dot {
    width: 6px; height: 6px; border-radius: 50%;
    background: currentColor; opacity: 0.5;
  }
  .nav-right {
    margin-left: auto;
    display: flex; align-items: center; gap: 12px;
  }
  .nav-user-wrap {
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .nav-user-meta {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    line-height: 1.15;
  }
  .nav-user-name {
    font-size: 11px;
    font-weight: 600;
    color: var(--gray-900);
  }
  .nav-user-role {
    font-size: 10px;
    color: var(--gray-500);
    font-weight: 500;
  }
  .nav-badge {
    background: var(--red);
    color: white; font-size: 11px; font-weight: 600;
    padding: 2px 8px; border-radius: 10px;
  }
  .nav-user {
    width: 32px; height: 32px; border-radius: 50%;
    background: var(--gray-100);
    display: flex; align-items: center; justify-content: center;
    font-size: 13px; font-weight: 600; color: var(--gray-700);
    cursor: pointer;
  }
  @media (max-width: 900px) {
    .nav-user-meta { display: none; }
  }

  /* ‚îÄ‚îÄ PLANT HEADER BAR ‚îÄ‚îÄ */
  .plant-header {
    background: var(--white);
    border-bottom: 1px solid var(--border);
    padding: 14px 24px;
    display: flex;
    align-items: center;
    gap: 16px;
  }
  .plant-selector {
    display: flex; align-items: center; gap: 8px;
    background: var(--gray-50);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 7px 12px;
    cursor: pointer;
    font-size: 13px; font-weight: 500;
    color: var(--gray-900);
  }
  .plant-selector select {
    border: none; background: transparent;
    font-family: var(--font); font-size: 13px; font-weight: 600;
    color: var(--gray-900); cursor: pointer; outline: none;
  }
  .status-badge {
    display: flex; align-items: center; gap: 5px;
    padding: 4px 10px; border-radius: 20px;
    font-size: 12px; font-weight: 600;
  }
  .status-badge.online { background: var(--green-bg); color: var(--green); }
  .status-badge.offline { background: #FAFAFA; color: var(--gray-500); }
  .status-dot {
    width: 7px; height: 7px; border-radius: 50%;
    background: currentColor;
    animation: pulse-status 2s infinite;
  }
  @keyframes pulse-status {
    0%,100% { opacity: 1; } 50% { opacity: 0.4; }
  }
  .plant-stats {
    margin-left: auto;
    display: flex; align-items: center; gap: 24px;
  }
  .stat-block { text-align: right; }
  .stat-label { font-size: 11px; color: var(--gray-500); font-weight: 500; }
  .stat-value { font-size: 18px; font-weight: 700; color: var(--gray-900); line-height: 1.2; font-family: var(--mono); }
  .stat-unit { font-size: 11px; color: var(--gray-500); font-weight: 400; }
  .stat-divider { width: 1px; height: 32px; background: var(--border); }
  .last-update { font-size: 11px; color: var(--gray-500); }

  /* ‚îÄ‚îÄ MAIN CONTENT ‚îÄ‚îÄ */
  .main-content { padding: 20px 24px; }

  /* ‚îÄ‚îÄ PANEL LAYOUT ‚îÄ‚îÄ */
  .panels {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
  }
  @media (max-width: 1100px) {
    .panels { grid-template-columns: 1fr; }
  }

  .panel {
    background: var(--white);
    border-radius: 8px;
    box-shadow: var(--shadow);
    overflow: hidden;
  }
  .panel-header {
    padding: 12px 16px;
    border-bottom: 1px solid var(--border);
    display: flex; align-items: center; gap: 10px;
  }
  .panel-icon {
    width: 28px; height: 28px; border-radius: 5px;
    display: flex; align-items: center; justify-content: center;
    font-size: 14px;
  }
  .panel-icon.cement { background: var(--red-light); }
  .panel-icon.raw { background: #E3F2FD; }
  .panel-title { font-size: 13px; font-weight: 700; color: var(--gray-900); }
  .panel-subtitle { font-size: 11px; color: var(--gray-500); }
  .panel-count {
    margin-left: auto;
    background: var(--gray-100);
    border-radius: 10px;
    padding: 2px 8px;
    font-size: 11px; font-weight: 600; color: var(--gray-700);
  }
  .panel-body {
    padding: 16px;
    overflow-x: auto;
  }
  .silo-grid {
    display: flex; gap: 12px;
    min-width: max-content;
  }

  /* ‚îÄ‚îÄ SILO CARD ‚îÄ‚îÄ */
  .silo-card {
    width: 148px;
    background: var(--white);
    border: 1px solid var(--border);
    border-radius: 8px;
    overflow: hidden;
    flex-shrink: 0;
    cursor: pointer;
    transition: box-shadow 0.2s, border-color 0.2s, transform 0.15s;
    position: relative;
  }
  .silo-card:hover {
    box-shadow: var(--shadow-md);
    transform: translateY(-2px);
  }
  .silo-card.border-green { border-top: 3px solid var(--status-green); }
  .silo-card.border-yellow { border-top: 3px solid var(--status-yellow); }
  .silo-card.border-red { border-top: 3px solid var(--status-red); }
  .silo-card.border-gray { border-top: 3px solid var(--status-gray); }

  /* Card Top Info */
  .card-top {
    padding: 10px 10px 6px;
    border-bottom: 1px solid var(--gray-100);
  }
  .card-capacity {
    font-size: 10px; color: var(--gray-500); font-weight: 500;
    display: flex; justify-content: space-between; align-items: center;
    margin-bottom: 2px;
  }
  .card-pct {
    font-size: 20px; font-weight: 700; font-family: var(--mono);
    line-height: 1;
  }
  .card-pct.green { color: var(--status-green); }
  .card-pct.yellow { color: var(--status-yellow); }
  .card-pct.red { color: var(--status-red); }
  .card-pct.gray { color: var(--status-gray); }
  .card-volume {
    font-size: 11px; color: var(--gray-700); font-weight: 600;
    font-family: var(--mono);
  }
  .card-remain {
    font-size: 10px; color: var(--gray-500);
  }
  .card-remain span { color: var(--gray-700); font-weight: 600; font-family: var(--mono); }

  /* Tank Visualization */
  .tank-wrap {
    padding: 8px 16px;
    display: flex; justify-content: center;
    position: relative;
  }
  .tank-outer {
    width: 68px; height: 120px;
    border: 2px solid var(--gray-300);
    border-radius: 6px 6px 4px 4px;
    position: relative;
    overflow: hidden;
    background: var(--gray-50);
  }
  .tank-fill {
    position: absolute;
    bottom: 0; left: 0; right: 0;
    transition: height 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    border-radius: 0 0 2px 2px;
  }
  .tank-fill.green { background: linear-gradient(180deg, #66BB6A 0%, #43A047 100%); }
  .tank-fill.yellow { background: linear-gradient(180deg, #FFD54F 0%, #FFB300 100%); }
  .tank-fill.red { background: linear-gradient(180deg, #EF5350 0%, #C62828 100%); }
  .tank-fill.gray { background: linear-gradient(180deg, #BDBDBD 0%, #9E9E9E 100%); }

  /* dotted lines */
  .tank-line {
    position: absolute; left: 0; right: 0;
    height: 1px;
    border-top: 1.5px dashed;
    display: flex; align-items: center;
    z-index: 2;
  }
  .tank-line.max { border-color: var(--red); top: 10%; }
  .tank-line.min { border-color: var(--yellow); bottom: 20%; }
  .tank-line-label {
    position: absolute; right: 3px;
    font-size: 8px; font-weight: 600;
    line-height: 1;
    margin-top: -8px;
  }
  .tank-line.max .tank-line-label { color: var(--red); }
  .tank-line.min .tank-line-label { color: var(--yellow); }

  .tank-level-text {
    position: absolute; right: -38px;
    font-size: 9px; font-weight: 600; font-family: var(--mono);
    color: var(--gray-700);
    white-space: nowrap;
  }

  /* quality badge inside tank */
  .quality-badge {
    position: absolute; top: 4px; right: 4px;
    width: 16px; height: 16px; border-radius: 50%;
    font-size: 9px; font-weight: 700;
    display: flex; align-items: center; justify-content: center;
    color: white; z-index: 3;
    cursor: pointer;
  }
  .quality-badge.q-ok { background: var(--status-green); }
  .quality-badge.q-warn { background: var(--status-yellow); }
  .quality-badge.q-fail { background: var(--status-red); }

  /* Card Bottom */
  .card-bottom {
    padding: 8px 10px 0;
    border-top: 1px solid var(--gray-100);
  }
  .card-silo-name {
    font-size: 10px; font-weight: 700; color: var(--gray-900);
    line-height: 1.3;
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  }
  .card-brand {
    font-size: 9px; color: var(--gray-500); margin-bottom: 4px;
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  }
  .card-minmax {
    display: flex; justify-content: space-between;
    font-size: 9px; color: var(--gray-500); font-family: var(--mono);
    margin-bottom: 8px;
  }
  .card-minmax span { font-weight: 600; color: var(--gray-700); }

  .card-actions {
    display: flex; flex-direction: column; gap: 4px;
    padding-bottom: 8px;
  }
  .btn-detail {
    background: var(--red);
    color: white; border: none; border-radius: 4px;
    padding: 5px 0; width: 100%; font-family: var(--font);
    font-size: 10px; font-weight: 600; cursor: pointer;
    transition: background 0.15s;
    display: flex; align-items: center; justify-content: center; gap: 4px;
  }
  .btn-detail:hover { background: var(--red-dark); }
  .btn-row { display: flex; gap: 4px; }
  .btn-order, .btn-no-order {
    flex: 1; border-radius: 4px; padding: 4px 0;
    font-family: var(--font); font-size: 9px; font-weight: 500; cursor: pointer;
    border: 1px solid var(--border); background: var(--white);
    transition: all 0.15s;
  }
  .btn-order:hover { background: var(--green-bg); border-color: var(--status-green); color: var(--green); }
  .btn-no-order:hover { background: var(--gray-100); }

  /* Quality test info (Cement Plant cards only) */
  .quality-test-info {
    background: var(--gray-50);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 5px 8px;
    margin-top: 0;
  }
  .qt-label {
    font-size: 9px; color: var(--gray-500); font-weight: 500;
    margin-bottom: 2px;
  }
  .qt-value {
    font-size: 10px; font-weight: 700; color: var(--gray-800);
    font-family: var(--mono);
    line-height: 1.4;
  }

  /* ‚îÄ‚îÄ QUALITY DETAIL PANEL ‚îÄ‚îÄ */
  .qd-groups { display: flex; flex-direction: column; gap: 16px; }
  .qd-group {
    background: var(--gray-50);
    border: 1px solid var(--border);
    border-radius: 6px;
    overflow: hidden;
  }
  .qd-group-title {
    font-size: 12px; font-weight: 700; color: var(--gray-700);
    padding: 8px 14px;
    background: var(--white);
    border-bottom: 1px solid var(--border);
    text-transform: uppercase; letter-spacing: 0.4px;
  }
  .qd-param-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
    gap: 8px;
    padding: 12px;
  }
  .qd-param {
    background: var(--white);
    border: 1px solid var(--border);
    border-radius: 5px;
    padding: 8px 10px;
    position: relative;
  }
  .qd-param-name {
    font-size: 10px; color: var(--gray-500); font-weight: 600;
    text-transform: uppercase; letter-spacing: 0.3px;
    margin-bottom: 3px;
  }
  .qd-param-val {
    font-size: 17px; font-weight: 700; font-family: var(--mono);
    line-height: 1.1;
  }
  .qd-param-unit { font-size: 10px; color: var(--gray-500); font-weight: 400; }
  .qd-param-spec { font-size: 9px; color: var(--gray-400); margin-top: 2px; }
  .qd-param-badge {
    position: absolute; top: 6px; right: 6px;
    font-size: 10px; width: 16px; height: 16px;
    border-radius: 50%; display: flex; align-items: center; justify-content: center;
    color: white; font-weight: 700;
  }
  .qd-param-badge.ok { background: var(--status-green); }
  .qd-param-badge.warn { background: var(--status-yellow); }
  .qd-param-badge.fail { background: var(--status-red); }
  .qd-param-badge.na { background: var(--gray-300); }
  .qd-param-val.ok { color: var(--status-green); }
  .qd-param-val.warn { color: var(--status-yellow); }
  .qd-param-val.fail { color: var(--status-red); }
  .qd-param-val.na { color: var(--gray-300); }

  /* Strength bars */
  .qd-strength-bars { padding: 12px 16px; display: flex; flex-direction: column; gap: 10px; }
  .str-row { display: flex; align-items: center; gap: 10px; }
  .str-label { width: 60px; font-size: 11px; font-weight: 600; color: var(--gray-700); flex-shrink: 0; }
  .str-bar-wrap { flex: 1; background: var(--gray-100); border-radius: 4px; height: 22px; position: relative; overflow: hidden; }
  .str-bar { height: 100%; border-radius: 4px; transition: width 0.6s ease; display: flex; align-items: center; padding-left: 8px; }
  .str-bar span { font-size: 11px; font-weight: 700; color: white; font-family: var(--mono); }
  .str-target-line {
    position: absolute; top: 0; bottom: 0; width: 2px;
    background: rgba(0,0,0,0.25); border-radius: 1px;
  }
  .str-val { width: 70px; text-align: right; font-size: 12px; font-weight: 700; font-family: var(--mono); }
  .str-spec { width: 80px; font-size: 10px; color: var(--gray-500); }

  /* DN table clickable row highlight */
  .dt tr.selected td { background: #FFF5F5 !important; }
  .dt td.dn-link { color: var(--red); font-weight: 700; cursor: pointer; text-decoration: underline; text-underline-offset: 2px; }

  /* ‚îÄ‚îÄ CEMENT PLANT SPECIFIC ‚îÄ‚îÄ */
  .lot-info {
    padding: 4px 10px 0;
    display: flex; flex-direction: column; gap: 2px;
  }
  .lot-row {
    display: flex; justify-content: space-between; align-items: center;
    font-size: 9px;
  }
  .lot-label { color: var(--gray-500); }
  .lot-val { font-family: var(--mono); font-weight: 600; color: var(--gray-700); font-size: 9px; }
  .quality-dot {
    width: 8px; height: 8px; border-radius: 50%; display: inline-block;
    margin-left: 3px;
  }
  .q-ok-dot { background: var(--status-green); }
  .q-warn-dot { background: var(--status-yellow); }
  .q-fail-dot { background: var(--status-red); }

  /* ‚îÄ‚îÄ SUMMARY STRIP ‚îÄ‚îÄ */
  .summary-strip {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 12px;
    margin-bottom: 16px;
  }
  .summary-card {
    background: var(--white);
    border-radius: 8px;
    padding: 12px 16px;
    box-shadow: var(--shadow);
    display: flex; align-items: center; gap: 12px;
  }
  .summary-icon {
    width: 36px; height: 36px; border-radius: 6px;
    display: flex; align-items: center; justify-content: center;
    font-size: 18px; flex-shrink: 0;
  }
  .summary-label { font-size: 11px; color: var(--gray-500); }
  .summary-value { font-size: 20px; font-weight: 700; font-family: var(--mono); color: var(--gray-900); }
  .summary-sub { font-size: 10px; color: var(--gray-500); }

  /* ‚îÄ‚îÄ ALERT STRIP ‚îÄ‚îÄ */
  .alert-strip {
    background: #FFF3E0;
    border: 1px solid #FFCC80;
    border-radius: 6px;
    padding: 8px 14px;
    display: flex; align-items: center; gap: 10px;
    margin-bottom: 16px;
    font-size: 12px;
    color: #E65100;
    font-weight: 500;
  }
  .alert-icon { font-size: 16px; }
  .alert-items { display: flex; gap: 12px; flex-wrap: wrap; }
  .alert-item {
    background: white; border-radius: 4px; padding: 2px 8px;
    border: 1px solid #FFCC80; font-size: 11px; font-weight: 600;
  }

  /* ‚îÄ‚îÄ MODAL / DETAIL VIEW ‚îÄ‚îÄ */
  .modal-overlay {
    display: none;
    position: fixed; inset: 0;
    background: rgba(0,0,0,0.45);
    z-index: 200;
    align-items: center; justify-content: center;
  }
  .modal-overlay.open { display: flex; }
  .modal {
    background: var(--white);
    border-radius: 10px;
    width: min(920px, 95vw);
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
  }
  .modal-header {
    padding: 16px 20px;
    border-bottom: 1px solid var(--border);
    display: flex; align-items: center; gap: 12px;
    position: sticky; top: 0; background: white; z-index: 10;
  }
  .modal-title { font-size: 16px; font-weight: 700; color: var(--gray-900); }
  .modal-subtitle { font-size: 12px; color: var(--gray-500); }
  .modal-close {
    margin-left: auto; background: none; border: none;
    font-size: 20px; cursor: pointer; color: var(--gray-500);
    width: 32px; height: 32px; border-radius: 4px;
    display: flex; align-items: center; justify-content: center;
  }
  .modal-close:hover { background: var(--gray-100); }
  .modal-body { padding: 20px; }
  .modal-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
  .modal-section {
    background: var(--gray-50);
    border-radius: 6px; padding: 14px;
    border: 1px solid var(--border);
  }
  .modal-section-title {
    font-size: 12px; font-weight: 700; color: var(--gray-700);
    margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.5px;
  }
  .modal-section.full { grid-column: 1 / -1; }

  /* Chart placeholder */
  .chart-area {
    height: 160px;
    background: white;
    border-radius: 4px;
    border: 1px solid var(--border);
    position: relative;
    overflow: hidden;
  }
  .chart-svg { width: 100%; height: 100%; }

  /* Dispatch Table */
  .dt {
    width: 100%; border-collapse: collapse; font-size: 11px;
  }
  .dt th {
    background: var(--gray-100); color: var(--gray-700);
    font-weight: 600; padding: 6px 10px; text-align: left;
    border-bottom: 1px solid var(--border);
  }
  .dt td {
    padding: 6px 10px; border-bottom: 1px solid var(--gray-100);
    color: var(--gray-900); font-family: var(--mono); font-size: 11px;
  }
  .dt tr:hover td { background: var(--gray-50); }
  .dt td:first-child { color: var(--red); font-weight: 600; cursor: pointer; }

  /* Quality params */
  .qp-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; }
  .qp-item {
    background: white; border-radius: 4px; padding: 8px;
    border: 1px solid var(--border);
  }
  .qp-label { font-size: 10px; color: var(--gray-500); margin-bottom: 2px; }
  .qp-val { font-size: 15px; font-weight: 700; font-family: var(--mono); }
  .qp-target { font-size: 9px; color: var(--gray-500); }
  .qp-val.ok { color: var(--status-green); }
  .qp-val.warn { color: var(--status-yellow); }
  .qp-val.fail { color: var(--status-red); }

  /* Lot timeline */
  .lot-timeline { display: flex; flex-direction: column; gap: 8px; }
  .lot-row-t {
    display: flex; align-items: center; gap: 10px;
    padding: 6px 10px;
    background: white; border-radius: 4px; border: 1px solid var(--border);
    font-size: 11px;
  }
  .lot-num { font-family: var(--mono); font-weight: 600; color: var(--gray-900); flex: 1; }
  .lot-date { color: var(--gray-500); font-size: 10px; }
  .lot-q { padding: 2px 8px; border-radius: 10px; font-size: 10px; font-weight: 600; }
  .lot-q.ok { background: var(--green-bg); color: var(--green); }
  .lot-q.warn { background: var(--yellow-bg); color: var(--yellow); }

  /* ‚îÄ‚îÄ FILTER BAR ‚îÄ‚îÄ */
  .filter-bar {
    background: var(--white);
    border-radius: 8px;
    padding: 10px 16px;
    margin-bottom: 16px;
    display: flex; align-items: center; gap: 10px;
    box-shadow: var(--shadow);
    flex-wrap: wrap;
  }
  .filter-label { font-size: 12px; font-weight: 600; color: var(--gray-700); }
  .filter-chip {
    padding: 4px 12px; border-radius: 16px;
    font-size: 12px; font-weight: 500;
    border: 1px solid var(--border);
    background: var(--white); cursor: pointer;
    transition: all 0.15s;
  }
  .filter-chip:hover { border-color: var(--red); color: var(--red); }
  .filter-chip.active { background: var(--red); color: white; border-color: var(--red); }
  .filter-search {
    margin-left: auto;
    display: flex; align-items: center; gap: 6px;
    background: var(--gray-50); border: 1px solid var(--border);
    border-radius: 6px; padding: 5px 10px;
  }
  .filter-search input {
    border: none; background: transparent; font-family: var(--font);
    font-size: 12px; outline: none; width: 160px; color: var(--gray-900);
  }

  /* National map */
  .national-map-stage {
    position: relative;
    height: 600px;
    overflow: hidden;
    background: #dceaf6;
  }
  #national-map {
    position: absolute;
    inset: 0;
    z-index: 1;
  }
  .map-overlay-legend {
    position: absolute;
    left: 14px;
    bottom: 14px;
    z-index: 400;
    background: rgba(255, 255, 255, 0.95);
    border: 1px solid #ddd;
    border-radius: 6px;
    padding: 10px 12px;
    min-width: 190px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  }
  .map-legend-row {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 11px;
    color: #333;
    line-height: 1.4;
  }
  .map-legend-row + .map-legend-row { margin-top: 6px; }
  .legend-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    display: inline-block;
    flex-shrink: 0;
  }
  .legend-dot.cement { background: #CC0000; border: 1px solid #fff; box-shadow: 0 0 0 1px rgba(0,0,0,0.15); }
  .legend-dot.cpac { background: #616161; }
  .legend-dot.alert { background: #F44336; }
  .map-marker {
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #fff;
    font-weight: 700;
    line-height: 1;
    border: 2px solid #fff;
    box-shadow: 0 1px 5px rgba(0,0,0,0.28);
    font-family: var(--font);
  }
  .map-marker.cement {
    width: 26px;
    height: 26px;
    background: #CC0000;
    font-size: 12px;
  }
  .map-marker.warning {
    width: 26px;
    height: 26px;
    background: #FFC107;
    font-size: 12px;
    color: #fff;
  }
  .map-marker.cpac {
    width: 10px;
    height: 10px;
    background: #616161;
    border: none;
    box-shadow: none;
  }
  .map-marker.alert {
    width: 12px;
    height: 12px;
    background: #F44336;
    border: 1px solid #fff;
    box-shadow: 0 1px 4px rgba(0,0,0,0.2);
  }
  .cpac-cluster {
    width: 34px;
    height: 34px;
    border-radius: 50%;
    background: rgba(97, 97, 97, 0.88);
    color: #fff;
    font-size: 11px;
    font-weight: 700;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 2px solid #fff;
    box-shadow: 0 1px 5px rgba(0,0,0,0.28);
  }
  .leaflet-control-attribution { font-size: 10px; }
  @media (max-width: 820px) {
    .national-map-stage { height: 430px; }
    .map-overlay-legend {
      left: 8px;
      bottom: 8px;
      transform: scale(0.95);
      transform-origin: left bottom;
    }
  }

  /* ‚îÄ‚îÄ TOOLTIPS ‚îÄ‚îÄ */
  [data-tip] { position: relative; }
  [data-tip]::after {
    content: attr(data-tip);
    position: absolute; bottom: calc(100% + 6px); left: 50%;
    transform: translateX(-50%);
    background: var(--gray-900); color: white;
    font-size: 11px; padding: 4px 8px; border-radius: 4px;
    white-space: pre; pointer-events: none;
    opacity: 0; transition: opacity 0.15s;
    z-index: 999; font-family: var(--font);
  }
  [data-tip]:hover::after { opacity: 1; }

  /* scrollbar */
  ::-webkit-scrollbar { width: 5px; height: 5px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--gray-300); border-radius: 3px; }
</style>
</head>
<body>

<!-- TOP NAV -->
<nav class="top-nav">
  <div class="nav-logo">
    <div class="nav-logo-icon">
      <img src="images/cpac-logo.jpg" alt="CPAC Logo">
    </div>
    <div>
      <div class="nav-logo-text">CPAC Silo Monitor</div>
      <div class="nav-logo-sub">Cement & Raw Material</div>
    </div>
  </div>
  <div class="nav-tabs">
    <div class="nav-tab active" onclick="switchTab(this, 'cement-view')">
      üè≠ Cement Plants
    </div>
    <div class="nav-tab" onclick="switchTab(this, 'cpac-view')">
      üè¢ CPAC Plants (300+)
    </div>
    <div class="nav-tab" onclick="switchTab(this, 'map-view')">
      üó∫Ô∏è National Map
    </div>
    <div class="nav-tab" onclick="switchTab(this, 'quality-view')">
      üß™ Quality Traceability
    </div>
  </div>
  <div class="nav-right">
    <span class="nav-badge">3 Alerts</span>
    <div class="nav-user-wrap">
      <div class="nav-user-meta">
        <div class="nav-user-name">Chaiwat Thepjun</div>
        <div class="nav-user-role">Digital Supply Chain</div>
      </div>
      <div class="nav-user">CT</div>
    </div>
  </div>
</nav>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CEMENT PLANT VIEW ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="cement-view">

  <!-- Plant Header -->
  <div class="plant-header">
    <div class="plant-selector">
      <span>üè≠</span>
      <select onchange="updatePlantHeader(this)">
        <option value="lampang">‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô‡∏•‡∏≥‡∏õ‡∏≤‡∏á ‚Äî ‡∏à.‡∏•‡∏≥‡∏õ‡∏≤‡∏á (SLP)</option>
        <option value="tha_luang">‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô‡∏ó‡πà‡∏≤‡∏´‡∏•‡∏ß‡∏á ‚Äî ‡∏à.‡∏™‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏µ (STL)</option>
        <option value="khao_wong">‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô‡πÄ‡∏Ç‡∏≤‡∏ß‡∏á ‚Äî ‡∏à.‡∏™‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏µ (SKW)</option>
        <option value="kaeng_khoi">‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô‡πÅ‡∏Å‡πà‡∏á‡∏Ñ‡∏≠‡∏¢ ‚Äî ‡∏à.‡∏™‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏µ (SKK)</option>
        <option value="thung_song">‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô‡∏ó‡∏∏‡πà‡∏á‡∏™‡∏á ‚Äî ‡∏à.‡∏ô‡∏Ñ‡∏£‡∏®‡∏£‡∏µ‡∏ò‡∏£‡∏£‡∏°‡∏£‡∏≤‡∏ä (STS)</option>
      </select>
    </div>
    <div class="status-badge online">
      <div class="status-dot"></div>
      Online
    </div>
    <div style="font-size:11px; color:var(--gray-500); margin-left:4px;">
      ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï: <strong style="color:var(--gray-700)">20 ‡∏Å.‡∏û. 2568 14:32</strong>
    </div>
    <div class="plant-stats">
      <div class="stat-block">
        <div class="stat-label">‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏£‡∏ß‡∏°</div>
        <div class="stat-value">42,850 <span class="stat-unit">‡∏ï‡∏±‡∏ô</span></div>
      </div>
      <div class="stat-divider"></div>
      <div class="stat-block">
        <div class="stat-label">Utilization</div>
        <div class="stat-value">67.4 <span class="stat-unit">%</span></div>
      </div>
      <div class="stat-divider"></div>
      <div class="stat-block">
        <div class="stat-label">‡πÑ‡∏ã‡πÇ‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
        <div class="stat-value">10 <span class="stat-unit">‡πÑ‡∏ã‡πÇ‡∏•</span></div>
      </div>
    </div>
  </div>

  <div class="main-content">

    <!-- Summary strip -->
    <div class="summary-strip">
      <div class="summary-card">
        <div class="summary-icon" style="background:#E8F5E9;">‚úÖ</div>
        <div>
          <div class="summary-label">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏õ‡∏Å‡∏ï‡∏¥</div>
          <div class="summary-value" style="color:var(--status-green)">6</div>
          <div class="summary-sub">‡πÑ‡∏ã‡πÇ‡∏•</div>
        </div>
      </div>
      <div class="summary-card">
        <div class="summary-icon" style="background:#FFF8E1;">‚ö†Ô∏è</div>
        <div>
          <div class="summary-label">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ï‡πà‡∏≥</div>
          <div class="summary-value" style="color:var(--status-yellow)">2</div>
          <div class="summary-sub">‡πÑ‡∏ã‡πÇ‡∏•</div>
        </div>
      </div>
      <div class="summary-card">
        <div class="summary-icon" style="background:#FFEBEE;">üö®</div>
        <div>
          <div class="summary-label">‡∏ß‡∏¥‡∏Å‡∏§‡∏ï</div>
          <div class="summary-value" style="color:var(--status-red)">1</div>
          <div class="summary-sub">‡πÑ‡∏ã‡πÇ‡∏•</div>
        </div>
      </div>
      <div class="summary-card">
        <div class="summary-icon" style="background:#E3F2FD;">üöö</div>
        <div>
          <div class="summary-label">‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>
          <div class="summary-value">28</div>
          <div class="summary-sub">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ DN</div>
        </div>
      </div>
      <div class="summary-card">
        <div class="summary-icon" style="background:#F3E5F5;">üß™</div>
        <div>
          <div class="summary-label">Lot ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</div>
          <div class="summary-value">LOT-47</div>
          <div class="summary-sub" style="color:var(--status-green)">‚óè Pass ‚Äî ‡∏ó‡πà‡∏≤‡∏´‡∏•‡∏ß‡∏á</div>
        </div>
      </div>
    </div>

    <!-- Alert strip -->
    <div class="alert-strip">
      <span class="alert-icon">‚ö†Ô∏è</span>
      <strong>‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô:</strong>
      <div class="alert-items">
        <span class="alert-item">SILO 3 ‚Äî ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤ Min</span>
        <span class="alert-item">SILO 7 ‚Äî Strength drop 3 DN ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ô</span>
        <span class="alert-item">SILO 9 ‚Äî ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• 2 ‡∏ä‡∏°.</span>
      </div>
    </div>

    <!-- Filter bar -->
    <div class="filter-bar">
      <span class="filter-label">‡∏Å‡∏£‡∏≠‡∏á:</span>
      <div class="filter-chip active" onclick="setChip(this)">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
      <div class="filter-chip" onclick="setChip(this)">üü¢ ‡∏õ‡∏Å‡∏ï‡∏¥</div>
      <div class="filter-chip" onclick="setChip(this)">üü° ‡∏ï‡πà‡∏≥</div>
      <div class="filter-chip" onclick="setChip(this)">üî¥ ‡∏ß‡∏¥‡∏Å‡∏§‡∏ï</div>
      <div class="filter-chip" onclick="setChip(this)">‚ö´ ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>
      <div class="filter-search">
        <span style="color:var(--gray-400)">üîç</span>
        <input type="text" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÑ‡∏ã‡πÇ‡∏•, Lot...">
      </div>
    </div>

    <!-- SINGLE PANEL: Cement Only -->
    <div class="panel">
      <div class="panel-header">
        <div class="panel-icon cement">üè≠</div>
        <div>
          <div class="panel-title">‡∏ã‡∏µ‡πÄ‡∏°‡∏ô‡∏ï‡πå / Cement Silos</div>
          <div class="panel-subtitle">Finished Product Storage ‚Äî Cement Plant</div>
        </div>
        <div class="panel-count" id="cement-silo-count">5 ‡πÑ‡∏ã‡πÇ‡∏•</div>
      </div>
      <div class="panel-body">
        <div class="silo-grid" id="cement-silos"></div>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CPAC PLANT VIEW ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="cpac-view" style="display:none">
  <div class="plant-header">
    <div class="plant-selector">
      <span>üè¢</span>
      <select>
        <option>CPAC ‡∏™‡∏≤‡∏Ç‡∏≤ ‡∏ö‡∏≤‡∏á‡∏ô‡∏≤-‡∏ï‡∏£‡∏≤‡∏î (‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏Ø)</option>
        <option>CPAC ‡∏™‡∏≤‡∏Ç‡∏≤ ‡∏£‡∏±‡∏ä‡∏î‡∏≤ (‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏Ø)</option>
        <option>CPAC ‡∏™‡∏≤‡∏Ç‡∏≤ ‡∏•‡∏≤‡∏î‡∏Å‡∏£‡∏∞‡∏ö‡∏±‡∏á (‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏Ø)</option>
        <option>CPAC ‡∏™‡∏≤‡∏Ç‡∏≤ ‡∏ö‡∏≤‡∏á‡∏ö‡∏±‡∏ß‡∏ó‡∏≠‡∏á (‡∏ô‡∏ô‡∏ó‡∏ö‡∏∏‡∏£‡∏µ)</option>
        <option>CPAC ‡∏™‡∏≤‡∏Ç‡∏≤ ‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà</option>
        <option>CPAC ‡∏™‡∏≤‡∏Ç‡∏≤ ‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô</option>
      </select>
    </div>
    <div class="status-badge online">
      <div class="status-dot"></div>
      Online
    </div>
    <div class="plant-stats">
      <div class="stat-block">
        <div class="stat-label">‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏£‡∏ß‡∏°</div>
        <div class="stat-value">342 <span class="stat-unit">‡∏ï‡∏±‡∏ô</span></div>
      </div>
      <div class="stat-divider"></div>
      <div class="stat-block">
        <div class="stat-label">‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ó‡∏µ‡πà‡∏°‡∏≤</div>
        <div class="stat-value" style="font-size:13px">STL + SKK</div>
      </div>
      <div class="stat-divider"></div>
      <div class="stat-block">
        <div class="stat-label">‡πÑ‡∏ã‡πÇ‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
        <div class="stat-value">4 <span class="stat-unit">‡πÑ‡∏ã‡πÇ‡∏•</span></div>
      </div>
    </div>
  </div>
  <div class="main-content">
    <div class="alert-strip" style="background:#E3F2FD; border-color:#90CAF9; color:#1565C0;">
      <span>‚ÑπÔ∏è</span> ‡πÑ‡∏ã‡πÇ‡∏•‡∏ô‡∏µ‡πâ‡∏£‡∏±‡∏ö‡∏ã‡∏µ‡πÄ‡∏°‡∏ô‡∏ï‡πå‡∏à‡∏≤‡∏Å‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô <strong>‡∏ó‡πà‡∏≤‡∏´‡∏•‡∏ß‡∏á STL (LOT-47)</strong> ‡πÅ‡∏•‡∏∞ <strong>‡πÅ‡∏Å‡πà‡∏á‡∏Ñ‡∏≠‡∏¢ SKK (LOT-23)</strong> ‚Äî Blend Est. 60% / 40%
    </div>
    <!-- CPAC: Cement Only Panel, full width -->
    <div class="panel">
      <div class="panel-header">
        <div class="panel-icon cement">üè≠</div>
        <div>
          <div class="panel-title">‡∏ã‡∏µ‡πÄ‡∏°‡∏ô‡∏ï‡πå ‚Äî CPAC Plant Silos</div>
          <div class="panel-subtitle">‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Source Plant & Quality Traceability</div>
        </div>
        <div class="panel-count">4 ‡πÑ‡∏ã‡πÇ‡∏•</div>
      </div>
      <div class="panel-body">
        <div class="silo-grid" id="cpac-silos"></div>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MAP VIEW ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="map-view" style="display:none">
  <div class="main-content">
    <div style="background:white; border-radius:8px; box-shadow:var(--shadow); overflow:hidden;">
      <div style="padding:14px 20px; border-bottom:1px solid var(--border); display:flex; align-items:center; gap:12px;">
        <strong>üó∫Ô∏è ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πà‡∏ß‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®</strong>
        <span style="font-size:12px; color:var(--gray-500)">‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î Silo</span>
        <div style="margin-left:auto; display:flex; gap:12px; font-size:12px;">
          <span>üî¥ ‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô‡∏ã‡∏µ‡πÄ‡∏°‡∏ô‡∏ï‡πå (5)</span>
          <span>‚ö´ CPAC Plants (300+)</span>
          <span>üü° ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</span>
        </div>
      </div>
      <!-- Thailand basemap container -->
      <div class="national-map-stage">
        <div id="national-map" aria-label="Thailand map"></div>
        <div class="map-overlay-legend">
          <div class="map-legend-row"><span class="legend-dot cement"></span><span>&#xE42;&#xE23;&#xE07;&#xE07;&#xE32;&#xE19;&#xE0B;&#xE35;&#xE40;&#xE21;&#xE19;&#xE15;&#xE4C; (5)</span></div>
          <div class="map-legend-row"><span class="legend-dot cpac"></span><span>CPAC Plants (300+)</span></div>
          <div class="map-legend-row"><span class="legend-dot alert"></span><span>&#xE41;&#xE08;&#xE49;&#xE07;&#xE40;&#xE15;&#xE37;&#xE2D;&#xE19; (Quality Alert)</span></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê QUALITY VIEW ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="quality-view" style="display:none">
  <div class="main-content">

    <!-- Filter/Summary strip -->
    <div class="filter-bar" style="margin-bottom:14px">
      <span class="filter-label">‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô:</span>
      <div class="filter-chip active" onclick="setChip(this)">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
      <div class="filter-chip" onclick="setChip(this)">STL ‡∏ó‡πà‡∏≤‡∏´‡∏•‡∏ß‡∏á</div>
      <div class="filter-chip" onclick="setChip(this)">SKK ‡πÅ‡∏Å‡πà‡∏á‡∏Ñ‡∏≠‡∏¢</div>
      <div class="filter-chip" onclick="setChip(this)">SLP ‡∏•‡∏≥‡∏õ‡∏≤‡∏á</div>
      <div class="filter-chip" onclick="setChip(this)">SKW ‡πÄ‡∏Ç‡∏≤‡∏ß‡∏á</div>
      <div class="filter-chip" onclick="setChip(this)">STS ‡∏ó‡∏∏‡πà‡∏á‡∏™‡∏á</div>
      <span class="filter-label" style="margin-left:8px">Lot:</span>
      <div class="filter-chip active" onclick="setChip(this)">LOT-47</div>
      <div class="filter-chip" onclick="setChip(this)">LOT-46</div>
      <div class="filter-search">
        <span style="color:var(--gray-400)">üîç</span>
        <input type="text" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ DN, Lot, SILO...">
      </div>
    </div>

    <div class="panel">
      <div class="panel-header">
        <div class="panel-icon cement">üß™</div>
        <div>
          <div class="panel-title">Quality Traceability ‚Äî DN Tracking</div>
          <div class="panel-subtitle">DN ‚Üí SILONO ‚Üí Lot ‚Üí ‡∏ú‡∏•‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏ã‡∏µ‡πÄ‡∏°‡∏ô‡∏ï‡πå ‚Üí CPAC Destination | ‡∏Ñ‡∏•‡∏¥‡∏Å DN ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏ú‡∏•‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÄ‡∏ï‡πá‡∏°</div>
        </div>
        <div style="margin-left:auto; display:flex; gap:8px; align-items:center;">
          <span style="font-size:11px; color:var(--gray-500)">‡πÅ‡∏™‡∏î‡∏á parameter:</span>
          <select id="qview-mode" onchange="renderQTable()" style="font-family:var(--font); font-size:12px; border:1px solid var(--border); border-radius:4px; padding:3px 8px; background:var(--gray-50); color:var(--gray-900); cursor:pointer; outline:none;">
            <option value="summary">‡∏™‡∏£‡∏∏‡∏õ (Strength + Setting)</option>
            <option value="chemical">‡πÄ‡∏Ñ‡∏°‡∏µ (SiO2, Al2O3, CaO...)</option>
            <option value="physical">‡∏Å‡∏≤‡∏¢‡∏†‡∏≤‡∏û (Blaine, Autoclave...)</option>
            <option value="compound">Compound (C3S, C2S, C3A...)</option>
            <option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (All Parameters)</option>
          </select>
        </div>
      </div>
      <div class="panel-body" style="min-width:0; overflow-x:auto; padding:0;">
        <div id="qtable-wrap" style="overflow-x:auto; padding:16px;"></div>
      </div>
    </div>

    <!-- Quality Detail Panel (shown when DN clicked) -->
    <div id="qdetail-panel" style="display:none; margin-top:16px;">
      <div class="panel">
        <div class="panel-header" style="background:var(--gray-50);">
          <div class="panel-icon cement">üìã</div>
          <div>
            <div class="panel-title" id="qd-title">‡∏ú‡∏•‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏ã‡∏µ‡πÄ‡∏°‡∏ô‡∏ï‡πå ‚Äî DN-250220-001</div>
            <div class="panel-subtitle" id="qd-sub">SILO-1 ¬∑ LOT-47 ¬∑ STL ‡∏ó‡πà‡∏≤‡∏´‡∏•‡∏ß‡∏á ¬∑ 20/02/68 08:14</div>
          </div>
          <button onclick="document.getElementById('qdetail-panel').style.display='none'"
            style="margin-left:auto; background:none; border:1px solid var(--border); border-radius:4px; padding:4px 10px; cursor:pointer; font-size:12px; color:var(--gray-500);">‚úï ‡∏õ‡∏¥‡∏î</button>
        </div>
        <div class="panel-body">
          <div class="qd-groups">

            <!-- Chemical Composition -->
            <div class="qd-group">
              <div class="qd-group-title">‚öóÔ∏è ‡∏≠‡∏á‡∏Ñ‡πå‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏ó‡∏≤‡∏á‡πÄ‡∏Ñ‡∏°‡∏µ (Chemical Composition)</div>
              <div class="qd-param-grid" id="qd-chemical"></div>
            </div>

            <!-- Compound Composition -->
            <div class="qd-group">
              <div class="qd-group-title">üî¨ Bogue Compound Composition</div>
              <div class="qd-param-grid" id="qd-compound"></div>
            </div>

            <!-- Physical Properties -->
            <div class="qd-group">
              <div class="qd-group-title">üìê ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏°‡∏ö‡∏±‡∏ï‡∏¥‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏¢‡∏†‡∏≤‡∏û (Physical Properties)</div>
              <div class="qd-param-grid" id="qd-physical"></div>
            </div>

            <!-- Strength -->
            <div class="qd-group">
              <div class="qd-group-title">üí™ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏î (Compressive Strength)</div>
              <div class="qd-strength-bars" id="qd-strength"></div>
            </div>

          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SILO DETAIL MODAL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="modal-overlay" id="modal" onclick="closeModalOverlay(event)">
  <div class="modal">
    <div class="modal-header">
      <div>
        <div class="modal-title">üõ¢Ô∏è SILO 1 ‚Äî SCG Hybrid Cement (SHC)</div>
        <div class="modal-subtitle">‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô‡∏ó‡πà‡∏≤‡∏´‡∏•‡∏ß‡∏á (STL) ¬∑ LOT-47 ¬∑ ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï: 20/02/68 14:32</div>
      </div>
      <button class="modal-close" onclick="closeModal()">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="modal-grid">

        <!-- Silo Level Chart -->
        <div class="modal-section full">
          <div class="modal-section-title">üìà Silo Level Timeline (7 ‡∏ß‡∏±‡∏ô)</div>
          <div class="chart-area">
            <svg class="chart-svg" viewBox="0 0 860 155" preserveAspectRatio="none">
              <defs>
                <linearGradient id="chartGrad" x1="0" y1="0" x2="0" y2="1">
                  <stop offset="0%" stop-color="#4CAF50" stop-opacity="0.3"/>
                  <stop offset="100%" stop-color="#4CAF50" stop-opacity="0.02"/>
                </linearGradient>
              </defs>
              <!-- Grid lines -->
              <line x1="0" y1="30" x2="860" y2="30" stroke="#F0F0F0" stroke-width="1"/>
              <line x1="0" y1="60" x2="860" y2="60" stroke="#F0F0F0" stroke-width="1"/>
              <line x1="0" y1="90" x2="860" y2="90" stroke="#F0F0F0" stroke-width="1"/>
              <line x1="0" y1="120" x2="860" y2="120" stroke="#F0F0F0" stroke-width="1"/>
              <!-- Max line -->
              <line x1="0" y1="20" x2="860" y2="20" stroke="#CC0000" stroke-width="1" stroke-dasharray="4,3" opacity="0.6"/>
              <!-- Min line -->
              <line x1="0" y1="110" x2="860" y2="110" stroke="#FFC107" stroke-width="1" stroke-dasharray="4,3" opacity="0.6"/>
              <!-- Area fill -->
              <path d="M0,100 C50,95 100,80 150,75 C200,70 250,55 300,60 C350,65 400,50 450,45 C500,40 550,55 600,50 C650,45 700,40 750,50 C800,58 830,62 860,58 L860,155 L0,155 Z"
                    fill="url(#chartGrad)"/>
              <!-- Line -->
              <path d="M0,100 C50,95 100,80 150,75 C200,70 250,55 300,60 C350,65 400,50 450,45 C500,40 550,55 600,50 C650,45 700,40 750,50 C800,58 830,62 860,58"
                    stroke="#4CAF50" stroke-width="2.5" fill="none" stroke-linecap="round"/>
              <!-- DN markers -->
              <g>
                <circle cx="200" cy="70" r="5" fill="#CC0000"/>
                <text x="200" y="65" text-anchor="middle" font-size="9" fill="#CC0000">DN</text>
                <circle cx="380" cy="55" r="5" fill="#CC0000"/>
                <text x="380" y="50" text-anchor="middle" font-size="9" fill="#CC0000">DN</text>
                <circle cx="580" cy="50" r="5" fill="#CC0000"/>
                <text x="580" y="45" text-anchor="middle" font-size="9" fill="#CC0000">DN</text>
                <circle cx="770" cy="52" r="5" fill="#CC0000"/>
                <text x="770" y="47" text-anchor="middle" font-size="9" fill="#CC0000">DN</text>
              </g>
              <!-- Labels -->
              <text x="5" y="25" font-size="9" fill="#CC0000">Max 96%</text>
              <text x="5" y="115" font-size="9" fill="#FFC107">Min 15%</text>
              <!-- X labels -->
              <text x="30" y="148" font-size="9" fill="#999">14 ‡∏Å.‡∏û.</text>
              <text x="155" y="148" font-size="9" fill="#999">15 ‡∏Å.‡∏û.</text>
              <text x="280" y="148" font-size="9" fill="#999">16 ‡∏Å.‡∏û.</text>
              <text x="405" y="148" font-size="9" fill="#999">17 ‡∏Å.‡∏û.</text>
              <text x="530" y="148" font-size="9" fill="#999">18 ‡∏Å.‡∏û.</text>
              <text x="655" y="148" font-size="9" fill="#999">19 ‡∏Å.‡∏û.</text>
              <text x="780" y="148" font-size="9" fill="#999">20 ‡∏Å.‡∏û.</text>
            </svg>
          </div>
        </div>

        <!-- Quality params -->
        <div class="modal-section">
          <div class="modal-section-title">üß™ Quality Parameters ‚Äî LOT-47</div>
          <div class="qp-grid">
            <div class="qp-item">
              <div class="qp-label">1d Strength</div>
              <div class="qp-val ok">18.4</div>
              <div class="qp-target">Target ‚â• 15 MPa</div>
            </div>
            <div class="qp-item">
              <div class="qp-label">3d Strength</div>
              <div class="qp-val ok">32.1</div>
              <div class="qp-target">Target ‚â• 28 MPa</div>
            </div>
            <div class="qp-item">
              <div class="qp-label">28d Strength</div>
              <div class="qp-val ok">42.1</div>
              <div class="qp-target">Target ‚â• 40 MPa</div>
            </div>
            <div class="qp-item">
              <div class="qp-label">Initial Set</div>
              <div class="qp-val ok">142</div>
              <div class="qp-target">Target 120‚Äì180 min</div>
            </div>
            <div class="qp-item">
              <div class="qp-label">Final Set</div>
              <div class="qp-val ok">185</div>
              <div class="qp-target">Target ‚â§ 240 min</div>
            </div>
            <div class="qp-item">
              <div class="qp-label">Blaine</div>
              <div class="qp-val warn">3,280</div>
              <div class="qp-target">Target 3,200‚Äì3,600</div>
            </div>
          </div>
        </div>

        <!-- Lot History -->
        <div class="modal-section">
          <div class="modal-section-title">üìã Lot Change History</div>
          <div class="lot-timeline">
            <div class="lot-row-t">
              <div class="lot-num">LOT-47</div>
              <div class="lot-date">18 ‡∏Å.‡∏û. 68 ‚Äî ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</div>
              <div class="lot-q ok">Pass</div>
            </div>
            <div class="lot-row-t">
              <div class="lot-num">LOT-46</div>
              <div class="lot-date">14‚Äì17 ‡∏Å.‡∏û. 68</div>
              <div class="lot-q warn">Review</div>
            </div>
            <div class="lot-row-t">
              <div class="lot-num">LOT-45</div>
              <div class="lot-date">10‚Äì13 ‡∏Å.‡∏û. 68</div>
              <div class="lot-q ok">Pass</div>
            </div>
            <div class="lot-row-t">
              <div class="lot-num">LOT-44</div>
              <div class="lot-date">5‚Äì9 ‡∏Å.‡∏û. 68</div>
              <div class="lot-q ok">Pass</div>
            </div>
          </div>
        </div>

        <!-- Dispatch Table -->
        <div class="modal-section full">
          <div class="modal-section-title">üöö Dispatch Records (DN)</div>
          <div style="overflow-x:auto">
            <table class="dt">
              <thead>
                <tr>
                  <th>DN No.</th>
                  <th>SHIPTO (CPAC)</th>
                  <th>PRDQTY (‡∏ï‡∏±‡∏ô)</th>
                  <th>Bay Out Date</th>
                  <th>Silo Level @ Dispatch</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>DN-250220-001</td><td>CPAC ‡∏ö‡∏≤‡∏á‡∏ô‡∏≤-‡∏ï‡∏£‡∏≤‡∏î</td>
                  <td>28.5</td><td>20/02/68 08:14</td>
                  <td>67.4% / 5,392T</td>
                </tr>
                <tr>
                  <td>DN-250219-047</td><td>CPAC ‡∏£‡∏±‡∏ä‡∏î‡∏≤</td>
                  <td>30.0</td><td>19/02/68 15:22</td>
                  <td>72.1% / 5,768T</td>
                </tr>
                <tr>
                  <td>DN-250219-031</td><td>CPAC ‡∏•‡∏≤‡∏î‡∏Å‡∏£‡∏∞‡∏ö‡∏±‡∏á</td>
                  <td>25.5</td><td>19/02/68 09:45</td>
                  <td>78.3% / 6,264T</td>
                </tr>
                <tr>
                  <td>DN-250218-028</td><td>CPAC ‡∏ö‡∏≤‡∏á‡∏ö‡∏±‡∏ß‡∏ó‡∏≠‡∏á</td>
                  <td>29.0</td><td>18/02/68 14:00</td>
                  <td>82.5% / 6,600T</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

      </div>
    </div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<script>
// ‚îÄ‚îÄ‚îÄ DATA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Cement Plant Silos (Cement only ‚Äî no Raw Material)
const cementData = [
  { name:'SILO 1', brand:'SCG SHC (Hybrid Cement)', cap:8000, vol:5392, min:800, max:7680, lot:'LOT-47', quality:'ok', type:'cement', lastTest:'20/02/68\n14:32 ‡∏ô.' },
  { name:'SILO 2', brand:'SCG SHC (Hybrid Cement)', cap:8000, vol:5696, min:800, max:7680, lot:'LOT-47', quality:'ok', type:'cement', lastTest:'20/02/68\n13:58 ‡∏ô.' },
  { name:'SILO 3', brand:'SCG Mortar Grade', cap:8000, vol:1136, min:800, max:7680, lot:'LOT-47', quality:'ok', type:'cement', lastTest:'20/02/68\n11:15 ‡∏ô.' },
  { name:'SILO 7', brand:'SCG HY-Bond (Low Heat)', cap:8000, vol:2248, min:800, max:7680, lot:'LOT-46', quality:'warn', type:'cement', lastTest:'20/02/68\n09:45 ‡∏ô.' },
  { name:'SILO 9', brand:'SCG Super G (Export)', cap:10000, vol:0, min:1000, max:9500, lot:'‚Äî', quality:'', type:'cement', nodata:true, lastTest:'19/02/68\n16:20 ‡∏ô.' },
];

// CPAC Plant Silos ‚Äî Cement only, sizes 180T and 100T
const cpacCementData = [
  { name:'SILO C1', brand:'SHC ‚Äî ‡∏ó‡πà‡∏≤‡∏´‡∏•‡∏ß‡∏á LOT-47', cap:180, vol:124, min:20, max:170, lot:'LOT-47', quality:'ok', type:'cement', source:'STL' },
  { name:'SILO C2', brand:'SHC ‚Äî ‡πÅ‡∏Å‡πà‡∏á‡∏Ñ‡∏≠‡∏¢ LOT-23', cap:180, vol:48, min:20, max:170, lot:'LOT-23', quality:'warn', type:'cement', source:'SKK' },
  { name:'SILO C3', brand:'Mortar Grade ‚Äî ‡∏ó‡πà‡∏≤‡∏´‡∏•‡∏ß‡∏á', cap:100, vol:82, min:12, max:95, lot:'LOT-47', quality:'ok', type:'cement', source:'STL' },
  { name:'SILO C4', brand:'SHC Blend Mix', cap:100, vol:14, min:12, max:95, lot:'MIX', quality:'fail', type:'cement', source:'STL+SKK' },
];

// ‚îÄ‚îÄ‚îÄ SILO CARD BUILDER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function getColor(pct, nodata) {
  if (nodata) return 'gray';
  if (pct < 15) return 'red';
  if (pct < 30) return 'yellow';
  return 'green';
}
function getBorderClass(pct, nodata) {
  const c = getColor(pct, nodata);
  return `border-${c}`;
}
function makeSiloCard(silo, isCpac) {
  const pct = silo.nodata ? 0 : Math.round(silo.vol / silo.cap * 100);
  const color = getColor(pct, silo.nodata);
  const avail = silo.cap - silo.vol;
  const fillH = silo.nodata ? 0 : Math.max(3, Math.round(pct * 1.16)); // max tank height 116px
  const maxPct = Math.round(silo.max / silo.cap * 100);
  const minPct = Math.round(silo.min / silo.cap * 100);
  const maxTop = Math.round((1 - maxPct/100) * 116);
  const minTop = Math.round((1 - minPct/100) * 116);

  let qualityBadge = '';
  if (silo.quality === 'ok') qualityBadge = '<div class="quality-badge q-ok" data-tip="Quality: Pass&#10;28d: 42.1 MPa ‚úì&#10;Setting: 185 min ‚úì">Q</div>';
  else if (silo.quality === 'warn') qualityBadge = '<div class="quality-badge q-warn" data-tip="Quality: Review&#10;28d: 38.2 MPa ‚ö†&#10;Strength drop detected">!</div>';
  else if (silo.quality === 'fail') qualityBadge = '<div class="quality-badge q-fail" data-tip="Quality: FAIL&#10;28d: 37.1 MPa ‚úó&#10;Out of spec">‚úó</div>';

  let lotSection = '';
  if (silo.type === 'cement') {
    lotSection = `
      <div class="lot-info">
        <div class="lot-row">
          <span class="lot-label">Lot</span>
          <span class="lot-val">${silo.lot||'‚Äî'}</span>
        </div>
        ${isCpac && silo.source ? `<div class="lot-row"><span class="lot-label">Source</span><span class="lot-val" style="color:var(--red)">${silo.source}</span></div>` : ''}
      </div>`;
  }

  return `
  <div class="silo-card ${getBorderClass(pct, silo.nodata)}" onclick="openModal()">
    <div class="card-top">
      <div class="card-capacity">
        <span>Cap: ${silo.cap.toLocaleString()} T</span>
      </div>
      <div class="card-pct ${color}">${silo.nodata ? '‚Äî' : pct + '%'}</div>
      <div class="card-volume">${silo.nodata ? '‚Äî' : silo.vol.toLocaleString()} ‡∏ï‡∏±‡∏ô</div>
      <div class="card-remain">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ <span>${silo.nodata ? '‚Äî' : avail.toLocaleString()} T</span></div>
    </div>

    <div class="tank-wrap">
      <div class="tank-outer" style="height:116px">
        <!-- Max line -->
        <div class="tank-line max" style="top:${maxTop}px">
          <span class="tank-line-label">‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î</span>
        </div>
        <!-- Min line -->
        <div class="tank-line min" style="top:${minTop}px">
          <span class="tank-line-label">‡∏ï‡πà‡∏≥‡∏™‡∏∏‡∏î</span>
        </div>
        <!-- Fill -->
        <div class="tank-fill ${color}" style="height:${fillH}px"></div>
        ${qualityBadge}
      </div>
      <div style="position:relative; margin-left:4px; display:flex; flex-direction:column; justify-content:flex-end; padding-bottom:${116-fillH}px; height:116px;">
        <span style="font-size:9px; font-family:var(--mono); font-weight:600; color:var(--gray-700); white-space:nowrap">‚Üë ${silo.nodata?'‚Äî':pct+'%'}</span>
      </div>
    </div>

    ${lotSection}

    <div class="card-bottom">
      <div class="card-silo-name" title="${silo.name}">${silo.name}</div>
      <div class="card-brand" title="${silo.brand}">${silo.brand}</div>
      <div class="card-minmax">
        <span>Min: <span>${silo.min.toLocaleString()}T</span></span>
        <span>Max: <span>${silo.max.toLocaleString()}T</span></span>
      </div>
      <div class="card-actions">
        <button class="btn-detail" onclick="event.stopPropagation(); openModal()">üî¥ ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</button>
        ${isCpac ? `
        <div class="btn-row">
          <button class="btn-order" onclick="event.stopPropagation()">‚úÖ ‡∏™‡∏±‡πà‡∏á</button>
          <button class="btn-no-order" onclick="event.stopPropagation()">‚úó ‡πÑ‡∏°‡πà‡∏™‡∏±‡πà‡∏á</button>
        </div>` : `
        <div class="quality-test-info">
          <div class="qt-label">üß™ ‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</div>
          <div class="qt-value">${silo.lastTest ? silo.lastTest.replace('\n','<br>') : '‚Äî'}</div>
        </div>`}
      </div>
    </div>
  </div>`;
}

// ‚îÄ‚îÄ‚îÄ RENDER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderAll() {
  document.getElementById('cement-silos').innerHTML = cementData.map(s => makeSiloCard(s, false)).join('');
  document.getElementById('cpac-silos').innerHTML = cpacCementData.map(s => makeSiloCard(s, true)).join('');
}
renderAll();

// Map stack detected: custom SVG only (no map library).
// Basemap upgraded to Leaflet + OSM with Thailand viewport/bounds while preserving markers and click behavior.
let nationalMap = null;
let nationalMapReady = false;

const thailandCenter = [13.7563, 100.5018];
const thailandBounds = L.latLngBounds([5.5, 97.0], [21.0, 106.5]);
const thailandPanBounds = L.latLngBounds([4.8, 96.0], [22.0, 107.8]);

function buildCpacPoints() {
  const seeds = [
    { lat: 13.7563, lng: 100.5018, count: 88, spread: 1.0 },
    { lat: 18.7883, lng: 98.9853, count: 34, spread: 1.0 },
    { lat: 16.4419, lng: 102.8350, count: 38, spread: 1.0 },
    { lat: 14.9799, lng: 102.0977, count: 34, spread: 1.0 },
    { lat: 12.6823, lng: 101.2810, count: 26, spread: 0.9 },
    { lat: 8.4304, lng: 99.9631, count: 22, spread: 0.9 },
    { lat: 7.0084, lng: 100.4747, count: 20, spread: 0.9 },
    { lat: 16.8211, lng: 100.2659, count: 24, spread: 1.0 },
    { lat: 17.4138, lng: 102.7870, count: 22, spread: 0.95 },
    { lat: 9.1401, lng: 99.3331, count: 20, spread: 0.85 }
  ];

  const points = [];
  seeds.forEach((seed, seedIndex) => {
    for (let i = 0; i < seed.count; i += 1) {
      const angle = ((i * 37) + (seedIndex * 57)) * Math.PI / 180;
      const radius = (0.08 + (i % 10) * 0.02) * seed.spread;
      const lat = seed.lat + (Math.sin(angle) * radius);
      const lng = seed.lng + (Math.cos(angle) * radius * 1.3);
      if (thailandBounds.contains([lat, lng])) points.push([lat, lng]);
    }
  });
  return points.slice(0, 320);
}

function ensureNationalMap() {
  if (nationalMapReady) return;
  if (!document.getElementById('national-map') || !window.L) return;
  nationalMapReady = true;

  nationalMap = L.map('national-map', {
    zoomControl: true,
    minZoom: 5,
    maxZoom: 12,
    maxBounds: thailandPanBounds,
    maxBoundsViscosity: 0.9,
    preferCanvas: true
  });

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(nationalMap);

  const thailandBoundary = {
    type: 'Feature',
    properties: { name: 'Thailand' },
    geometry: {
      type: 'Polygon',
      coordinates: [[
        [97.4, 20.4], [98.7, 20.2], [99.9, 20.1], [101.5, 19.4], [103.0, 18.3],
        [104.7, 17.2], [104.2, 15.9], [103.4, 14.6], [102.9, 13.5], [101.5, 12.6],
        [100.6, 11.8], [99.7, 10.3], [99.4, 8.9], [99.8, 7.9], [100.2, 7.1],
        [100.0, 6.2], [99.3, 6.0], [98.9, 6.8], [98.8, 8.3], [98.6, 9.8],
        [98.3, 11.2], [98.1, 12.5], [97.7, 13.8], [97.5, 15.2], [97.3, 16.8],
        [97.2, 18.0], [97.3, 19.3], [97.4, 20.4]
      ]]
    }
  };

  L.geoJSON(thailandBoundary, {
    interactive: false,
    style: {
      color: '#9AA5B1',
      weight: 1,
      fillColor: '#DDE3E8',
      fillOpacity: 0.08
    }
  }).addTo(nationalMap);

  const cementIcon = L.divIcon({
    className: '',
    html: '<div class="map-marker cement">\uD83C\uDFED</div>',
    iconSize: [26, 26],
    iconAnchor: [13, 13]
  });
  const cementWarnIcon = L.divIcon({
    className: '',
    html: '<div class="map-marker warning">\u26A0</div>',
    iconSize: [26, 26],
    iconAnchor: [13, 13]
  });
  const cpacIcon = L.divIcon({
    className: '',
    html: '<div class="map-marker cpac"></div>',
    iconSize: [10, 10],
    iconAnchor: [5, 5]
  });
  const alertIcon = L.divIcon({
    className: '',
    html: '<div class="map-marker alert"></div>',
    iconSize: [12, 12],
    iconAnchor: [6, 6]
  });

  const cementPlants = [
    { name: 'Lampang (SLP)', province: 'Lampang', lat: 18.2888, lng: 99.4908, warn: false },
    { name: 'Tha Luang (STL)', province: 'Saraburi', lat: 14.6401, lng: 100.9126, warn: false },
    { name: 'Khao Wong (SKW)', province: 'Saraburi', lat: 14.5930, lng: 101.0106, warn: false },
    { name: 'Kaeng Khoi (SKK)', province: 'Saraburi', lat: 14.5861, lng: 100.9972, warn: true },
    { name: 'Thung Song (STS)', province: 'Nakhon Si Thammarat', lat: 8.1647, lng: 99.6806, warn: false }
  ];

  const fitPoints = [];
  cementPlants.forEach((plant) => {
    const marker = L.marker([plant.lat, plant.lng], {
      icon: plant.warn ? cementWarnIcon : cementIcon
    }).addTo(nationalMap);
    marker.bindTooltip(`${plant.name}<br>${plant.province}`, { direction: 'top' });
    marker.on('click', () => openModal());
    fitPoints.push([plant.lat, plant.lng]);
  });

  const cpacPoints = buildCpacPoints();
  const cpacCluster = L.markerClusterGroup({
    showCoverageOnHover: false,
    maxClusterRadius: 45,
    spiderfyOnMaxZoom: true,
    iconCreateFunction(cluster) {
      return L.divIcon({
        className: 'cpac-cluster',
        html: `<span>${cluster.getChildCount()}</span>`,
        iconSize: [34, 34]
      });
    }
  });

  cpacPoints.forEach((point) => {
    const marker = L.marker(point, { icon: cpacIcon });
    marker.on('click', () => openModal());
    cpacCluster.addLayer(marker);
    fitPoints.push(point);
  });
  nationalMap.addLayer(cpacCluster);

  const qualityAlerts = [
    { lat: 13.69, lng: 100.75, label: 'Quality Alert' }
  ];
  qualityAlerts.forEach((row) => {
    const alertMarker = L.marker([row.lat, row.lng], { icon: alertIcon }).addTo(nationalMap);
    alertMarker.bindTooltip(row.label, { direction: 'top' });
    alertMarker.on('click', () => openModal());
    fitPoints.push([row.lat, row.lng]);
  });

  if (fitPoints.length > 0) {
    nationalMap.fitBounds(L.latLngBounds(fitPoints), { padding: [24, 24], maxZoom: 7 });
  } else {
    nationalMap.setView(thailandCenter, 6);
  }

  setTimeout(() => nationalMap.invalidateSize(), 0);
}

// ‚îÄ‚îÄ‚îÄ TABS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function switchTab(el, viewId) {
  document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
  el.classList.add('active');
  ['cement-view','cpac-view','map-view','quality-view'].forEach(id => {
    document.getElementById(id).style.display = id === viewId ? '' : 'none';
  });
  if (viewId === 'map-view') {
    ensureNationalMap();
    if (nationalMap) setTimeout(() => nationalMap.invalidateSize(), 0);
  }
}

// ‚îÄ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openModal() {
  document.getElementById('modal').classList.add('open');
}
function closeModal() {
  document.getElementById('modal').classList.remove('open');
}
function closeModalOverlay(e) {
  if (e.target === document.getElementById('modal')) closeModal();
}

// ‚îÄ‚îÄ‚îÄ FILTER CHIPS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setChip(el) {
  document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
  el.classList.add('active');
}

// ‚îÄ‚îÄ‚îÄ PLANT HEADER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function updatePlantHeader(sel) {
  const vals = {
    lampang:    {stock:'51,100', util:'79.5', silos:'8'},
    tha_luang:  {stock:'42,850', util:'67.4', silos:'10'},
    khao_wong:  {stock:'38,200', util:'59.7', silos:'7'},
    kaeng_khoi: {stock:'45,600', util:'71.2', silos:'9'},
    thung_song: {stock:'29,400', util:'45.8', silos:'6'},
  };
  const v = vals[sel.value];
  if (v) {
    const statVals = document.querySelectorAll('#cement-view .stat-value');
    if (statVals[0]) statVals[0].innerHTML = `${v.stock} <span class="stat-unit">‡∏ï‡∏±‡∏ô</span>`;
    if (statVals[1]) statVals[1].innerHTML = `${v.util} <span class="stat-unit">%</span>`;
    if (statVals[2]) statVals[2].innerHTML = `${v.silos} <span class="stat-unit">‡πÑ‡∏ã‡πÇ‡∏•</span>`;
  }
}

// ‚îÄ‚îÄ‚îÄ ESC to close ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.addEventListener('keydown', e => { if (e.key === 'Escape') closeModal(); });

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// QUALITY TRACEABILITY DATA
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const specLimits = {
  SiO2:        { min: 19.0,  max: 22.0,  unit: '%' },
  Al2O3:       { min: 4.0,   max: 6.5,   unit: '%' },
  Fe2O3:       { min: 2.5,   max: 4.5,   unit: '%' },
  CaO:         { min: 62.0,  max: 67.0,  unit: '%' },
  MgO:         { min: null,  max: 5.0,   unit: '%' },
  SO3:         { min: null,  max: 3.5,   unit: '%' },
  K2O:         { min: null,  max: 1.5,   unit: '%' },
  Na2O:        { min: null,  max: 0.6,   unit: '%' },
  Alkalies:    { min: null,  max: 0.80,  unit: '%' },
  LOI:         { min: null,  max: 3.0,   unit: '%' },
  Insoluble:   { min: null,  max: 1.5,   unit: '%' },
  C3S:         { min: 50.0,  max: 65.0,  unit: '%' },
  C2S:         { min: 10.0,  max: 25.0,  unit: '%' },
  C3A:         { min: 6.0,   max: 11.0,  unit: '%' },
  C4AF:        { min: 8.0,   max: 14.0,  unit: '%' },
  Blaine:      { min: 3200,  max: 3600,  unit: 'cm¬≤/g' },
  Autoclave:   { min: null,  max: 0.80,  unit: '%' },
  VicatInitial:{ min: 120,   max: 180,   unit: '‡∏ô‡∏≤‡∏ó‡∏µ' },
  VicatFinal:  { min: null,  max: 240,   unit: '‡∏ô‡∏≤‡∏ó‡∏µ' },
  Aircontent:  { min: null,  max: 12.0,  unit: '%' },
  STR1D:       { min: 12.0,  max: null,  unit: 'MPa' },
  STR3D:       { min: 28.0,  max: null,  unit: 'MPa' },
  STR7D:       { min: 34.0,  max: null,  unit: 'MPa' },
  STR28D:      { min: 42.0,  max: null,  unit: 'MPa' },
};

const qDNData = [
  {
    dn:'DN-250220-001', silo:'SILO-1', lot:'LOT-47', plant:'STL', siloLvl:'67.4%', siloTon:'5,392T',
    shipto:'CPAC ‡∏ö‡∏≤‡∏á‡∏ô‡∏≤-‡∏ï‡∏£‡∏≤‡∏î', bayout:'20/02/68 08:14', status:'pass',
    q:{ SiO2:20.42, Al2O3:5.18, Fe2O3:3.21, CaO:64.85, MgO:1.92, SO3:2.41, K2O:0.52, Na2O:0.18, Alkalies:0.52,
        LOI:1.82, Insoluble:0.62, C3S:58.4, C2S:16.2, C3A:8.7, C4AF:9.8,
        Blaine:3420, Autoclave:0.12, VicatInitial:142, VicatFinal:185, Aircontent:7.2,
        STR1D:14.8, STR3D:29.6, STR7D:36.2, STR28D:42.1 }
  },
  {
    dn:'DN-250220-002', silo:'SILO-2', lot:'LOT-47', plant:'STL', siloLvl:'71.2%', siloTon:'5,696T',
    shipto:'CPAC ‡∏£‡∏±‡∏ä‡∏î‡∏≤', bayout:'20/02/68 09:02', status:'pass',
    q:{ SiO2:20.18, Al2O3:5.04, Fe2O3:3.35, CaO:65.10, MgO:2.01, SO3:2.38, K2O:0.49, Na2O:0.16, Alkalies:0.48,
        LOI:1.74, Insoluble:0.58, C3S:59.1, C2S:15.8, C3A:8.4, C4AF:10.2,
        Blaine:3385, Autoclave:0.10, VicatInitial:148, VicatFinal:192, Aircontent:6.9,
        STR1D:14.5, STR3D:29.1, STR7D:35.8, STR28D:41.8 }
  },
  {
    dn:'DN-250220-003', silo:'SILO-7', lot:'LOT-46', plant:'STL', siloLvl:'28.1%', siloTon:'2,248T',
    shipto:'CPAC ‡∏•‡∏≤‡∏î‡∏Å‡∏£‡∏∞‡∏ö‡∏±‡∏á', bayout:'20/02/68 10:30', status:'warn',
    q:{ SiO2:21.05, Al2O3:5.62, Fe2O3:3.48, CaO:63.20, MgO:2.35, SO3:2.88, K2O:0.64, Na2O:0.22, Alkalies:0.64,
        LOI:2.11, Insoluble:0.88, C3S:54.2, C2S:18.9, C3A:9.1, C4AF:10.6,
        Blaine:3210, Autoclave:0.22, VicatInitial:162, VicatFinal:210, Aircontent:8.4,
        STR1D:12.8, STR3D:27.4, STR7D:33.5, STR28D:38.2 }
  },
  {
    dn:'DN-250220-004', silo:'SILO-7', lot:'LOT-46', plant:'STL', siloLvl:'24.5%', siloTon:'1,960T',
    shipto:'CPAC ‡∏ö‡∏≤‡∏á‡∏ö‡∏±‡∏ß‡∏ó‡∏≠‡∏á', bayout:'20/02/68 11:15', status:'fail',
    q:{ SiO2:21.38, Al2O3:5.85, Fe2O3:3.55, CaO:62.80, MgO:2.48, SO3:3.02, K2O:0.71, Na2O:0.25, Alkalies:0.72,
        LOI:2.35, Insoluble:1.02, C3S:52.8, C2S:19.4, C3A:9.5, C4AF:10.8,
        Blaine:3150, Autoclave:0.31, VicatInitial:170, VicatFinal:218, Aircontent:9.1,
        STR1D:11.9, STR3D:25.8, STR7D:32.1, STR28D:37.1 }
  },
  {
    dn:'DN-250220-005', silo:'SILO-3', lot:'LOT-47', plant:'STL', siloLvl:'14.2%', siloTon:'1,136T',
    shipto:'CPAC ‡∏™‡∏∏‡∏Ç‡∏∏‡∏°‡∏ß‡∏¥‡∏ó', bayout:'20/02/68 12:00', status:'pass',
    q:{ SiO2:20.05, Al2O3:4.98, Fe2O3:3.18, CaO:65.42, MgO:1.88, SO3:2.35, K2O:0.47, Na2O:0.15, Alkalies:0.46,
        LOI:1.68, Insoluble:0.55, C3S:60.2, C2S:15.1, C3A:8.2, C4AF:9.7,
        Blaine:3480, Autoclave:0.09, VicatInitial:138, VicatFinal:188, Aircontent:6.8,
        STR1D:15.2, STR3D:30.4, STR7D:37.1, STR28D:42.5 }
  },
  {
    dn:'DN-250219-047', silo:'SILO-1', lot:'LOT-47', plant:'STL', siloLvl:'72.1%', siloTon:'5,768T',
    shipto:'CPAC ‡∏£‡∏±‡∏ä‡∏î‡∏≤', bayout:'19/02/68 15:22', status:'pass',
    q:{ SiO2:20.28, Al2O3:5.10, Fe2O3:3.24, CaO:64.95, MgO:1.95, SO3:2.42, K2O:0.51, Na2O:0.17, Alkalies:0.50,
        LOI:1.79, Insoluble:0.60, C3S:58.8, C2S:16.0, C3A:8.5, C4AF:9.9,
        Blaine:3410, Autoclave:0.11, VicatInitial:144, VicatFinal:188, Aircontent:7.0,
        STR1D:14.9, STR3D:29.8, STR7D:36.5, STR28D:42.3 }
  },
];

// ‚îÄ‚îÄ Helper: check spec status ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function getParamStatus(key, val) {
  const s = specLimits[key];
  if (!s) return 'na';
  if (s.min !== null && val < s.min) return 'fail';
  if (s.max !== null && val > s.max) return 'fail';
  const range = (s.max||100) - (s.min||0);
  const warn = range * 0.1;
  if (s.min !== null && val < s.min + warn) return 'warn';
  if (s.max !== null && val > s.max - warn) return 'warn';
  return 'ok';
}

function statusIcon(st) {
  if (st === 'ok') return '‚úì';
  if (st === 'warn') return '!';
  if (st === 'fail') return '‚úó';
  return '‚Äî';
}

function formatSpec(key) {
  const s = specLimits[key];
  if (!s) return '';
  if (s.min !== null && s.max !== null) return `${s.min}‚Äì${s.max} ${s.unit}`;
  if (s.min !== null) return `‚â• ${s.min} ${s.unit}`;
  if (s.max !== null) return `‚â§ ${s.max} ${s.unit}`;
  return '';
}

// ‚îÄ‚îÄ Param cell ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function makeParamCell(key, val) {
  const s = specLimits[key] || { unit: '' };
  const st = getParamStatus(key, val);
  return `
  <div class="qd-param">
    <div class="qd-param-badge ${st}">${statusIcon(st)}</div>
    <div class="qd-param-name">${key}</div>
    <div class="qd-param-val ${st}">${val !== undefined ? val.toFixed(val >= 100 ? 0 : 2) : '‚Äî'}</div>
    <div class="qd-param-unit">${s.unit}</div>
    <div class="qd-param-spec">${formatSpec(key)}</div>
  </div>`;
}

// ‚îÄ‚îÄ Strength bar ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function makeStrBar(label, val, spec, maxVal) {
  const pct = Math.min(100, (val / maxVal) * 100);
  const specPct = Math.min(100, (spec / maxVal) * 100);
  const st = getParamStatus(label === '1D' ? 'STR1D' : label === '3D' ? 'STR3D' : label === '7D' ? 'STR7D' : 'STR28D', val);
  const colors = { ok: '#4CAF50', warn: '#FFC107', fail: '#F44336' };
  const color = colors[st] || '#9E9E9E';
  const stName = val.toFixed(1);
  return `
  <div class="str-row">
    <div class="str-label">${label}</div>
    <div class="str-bar-wrap">
      <div class="str-bar" style="width:${pct}%; background:${color};">
        <span>${stName}</span>
      </div>
      <div class="str-target-line" style="left:${specPct}%;" title="Spec: ${spec} MPa"></div>
    </div>
    <div class="str-val" style="color:${color}">${stName} MPa</div>
    <div class="str-spec">‚â• ${spec} MPa</div>
  </div>`;
}

// ‚îÄ‚îÄ Overall status badge ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function statusBadge(st) {
  if (st === 'pass') return `<span style="background:var(--green-bg);color:var(--green);padding:2px 8px;border-radius:10px;font-size:10px;font-weight:600">‚úì Pass</span>`;
  if (st === 'warn') return `<span style="background:var(--yellow-bg);color:var(--yellow);padding:2px 8px;border-radius:10px;font-size:10px;font-weight:600">‚ö† Review</span>`;
  return `<span style="background:#FFEBEE;color:var(--status-red);padding:2px 8px;border-radius:10px;font-size:10px;font-weight:600">‚úó Fail</span>`;
}

// ‚îÄ‚îÄ Main Q-table renderer ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderQTable() {
  const mode = document.getElementById('qview-mode').value;

  const chemKeys    = ['SiO2','Al2O3','Fe2O3','CaO','MgO','SO3','K2O','Na2O','Alkalies','LOI','Insoluble'];
  const compndKeys  = ['C3S','C2S','C3A','C4AF'];
  const physKeys    = ['Blaine','Autoclave','VicatInitial','VicatFinal','Aircontent'];
  const strKeys     = ['STR1D','STR3D','STR7D','STR28D'];

  let extraCols = [];
  if (mode === 'chemical')  extraCols = chemKeys;
  if (mode === 'compound')  extraCols = compndKeys;
  if (mode === 'physical')  extraCols = physKeys;
  if (mode === 'all')       extraCols = [...chemKeys,...compndKeys,...physKeys,...strKeys];
  // summary always shows STR + Setting
  const summaryExtra = ['STR1D','STR3D','STR7D','STR28D','VicatInitial','VicatFinal'];
  if (mode === 'summary') extraCols = summaryExtra;

  const units = { STR1D:'MPa', STR3D:'MPa', STR7D:'MPa', STR28D:'MPa',
    VicatInitial:'‡∏ô‡∏≤‡∏ó‡∏µ', VicatFinal:'‡∏ô‡∏≤‡∏ó‡∏µ', Blaine:'cm¬≤/g',
    Autoclave:'%', Aircontent:'%' };

  const colLabel = {
    SiO2:'SiO‚ÇÇ', Al2O3:'Al‚ÇÇO‚ÇÉ', Fe2O3:'Fe‚ÇÇO‚ÇÉ', CaO:'CaO', MgO:'MgO',
    SO3:'SO‚ÇÉ', K2O:'K‚ÇÇO', Na2O:'Na‚ÇÇO', Alkalies:'Alkalies', LOI:'LOI', Insoluble:'Insol.',
    C3S:'C‚ÇÉS', C2S:'C‚ÇÇS', C3A:'C‚ÇÉA', C4AF:'C‚ÇÑAF',
    Blaine:'Blaine', Autoclave:'Autoclave', VicatInitial:'Vicat Init.', VicatFinal:'Vicat Final',
    Aircontent:'Air%', STR1D:'1D MPa', STR3D:'3D MPa', STR7D:'7D MPa', STR28D:'28D MPa'
  };

  let thead = `<tr>
    <th style="position:sticky;left:0;background:#F5F5F5;z-index:2">DN No.</th>
    <th>Plant</th><th>SILO</th><th>Lot</th>
    <th>Silo Level @ Dispatch</th>
    <th>SHIPTO</th><th>Bay Out</th>`;
  extraCols.forEach(k => {
    thead += `<th style="text-align:center">${colLabel[k]||k}</th>`;
  });
  thead += `<th style="text-align:center">Status</th></tr>`;

  let tbody = '';
  qDNData.forEach((row, i) => {
    const q = row.q;
    // overall worst status across shown cols
    let worst = 'ok';
    extraCols.forEach(k => {
      const st = getParamStatus(k, q[k]);
      if (st === 'fail') worst = 'fail';
      else if (st === 'warn' && worst !== 'fail') worst = 'warn';
    });
    const rowStatus = row.status; // use DN-level status

    let cols = '';
    extraCols.forEach(k => {
      const val = q[k];
      const st = getParamStatus(k, val);
      const color = st === 'ok' ? 'var(--status-green)' : st === 'warn' ? 'var(--status-yellow)' : st === 'fail' ? 'var(--status-red)' : 'var(--gray-300)';
      const u = specLimits[k] ? specLimits[k].unit : '';
      cols += `<td style="text-align:center; font-family:var(--mono); font-size:11px; color:${color}; font-weight:600">${val !== undefined ? val.toFixed(val >= 100 ? 0 : 2) : '‚Äî'}<span style="font-size:9px;color:var(--gray-400);font-weight:400"> ${u}</span></td>`;
    });

    tbody += `<tr id="qrow-${i}" onclick="showQDetail(${i}, this)">
      <td class="dn-link" style="position:sticky;left:0;background:white;white-space:nowrap">${row.dn}</td>
      <td style="font-weight:600;color:var(--red)">${row.plant}</td>
      <td>${row.silo}</td>
      <td style="font-family:var(--mono)">${row.lot}</td>
      <td style="font-family:var(--mono);font-size:11px">${row.siloLvl} / ${row.siloTon}</td>
      <td style="white-space:nowrap">${row.shipto}</td>
      <td style="font-family:var(--mono);font-size:11px;white-space:nowrap">${row.bayout}</td>
      ${cols}
      <td style="text-align:center">${statusBadge(rowStatus)}</td>
    </tr>`;
  });

  document.getElementById('qtable-wrap').innerHTML =
    `<table class="dt" style="min-width:max-content; width:100%"><thead>${thead}</thead><tbody>${tbody}</tbody></table>`;
}

// ‚îÄ‚îÄ Show quality detail panel ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showQDetail(idx, rowEl) {
  // highlight row
  document.querySelectorAll('#qtable-wrap tr').forEach(r => r.classList.remove('selected'));
  rowEl.classList.add('selected');

  const row = qDNData[idx];
  const q = row.q;

  document.getElementById('qd-title').textContent = `‡∏ú‡∏•‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏ã‡∏µ‡πÄ‡∏°‡∏ô‡∏ï‡πå ‚Äî ${row.dn}`;
  document.getElementById('qd-sub').textContent = `${row.silo} ¬∑ ${row.lot} ¬∑ ${row.plant} ¬∑ ${row.shipto} ¬∑ ${row.bayout}`;

  // Chemical
  const chemKeys = ['SiO2','Al2O3','Fe2O3','CaO','MgO','SO3','K2O','Na2O','Alkalies','LOI','Insoluble'];
  document.getElementById('qd-chemical').innerHTML = chemKeys.map(k => makeParamCell(k, q[k])).join('');

  // Compound
  const compKeys = ['C3S','C2S','C3A','C4AF'];
  document.getElementById('qd-compound').innerHTML = compKeys.map(k => makeParamCell(k, q[k])).join('');

  // Physical
  const physKeys = ['Blaine','Autoclave','VicatInitial','VicatFinal','Aircontent'];
  document.getElementById('qd-physical').innerHTML = physKeys.map(k => makeParamCell(k, q[k])).join('');

  // Strength bars
  document.getElementById('qd-strength').innerHTML = `
    ${makeStrBar('1D',  q.STR1D,  12.0, 50)}
    ${makeStrBar('3D',  q.STR3D,  28.0, 50)}
    ${makeStrBar('7D',  q.STR7D,  34.0, 50)}
    ${makeStrBar('28D', q.STR28D, 42.0, 60)}`;

  document.getElementById('qdetail-panel').style.display = '';
  document.getElementById('qdetail-panel').scrollIntoView({ behavior: 'smooth', block: 'start' });
}

// Initial render
renderQTable();
</script>
</body>
</html>


